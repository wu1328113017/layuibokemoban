<!DOCTYPE html>
<html>
<head>
<style>body{padding:1.875rem;}</style><meta charset='UTF-8'>
</head>
<body><p>之前在一家公司工作的时候，代码没写多少，但放到服务器上面就爆，使得服务器都运行不了，后来大佬来看一下代码就找出了大致的问题，其中有一点就是频繁的操作数据库，怎么频繁的呢？就是写一个循环，循环里面写查询语句，因为mybatis每使用一条mapper都是会先连接数据库然后操作再关闭，循环的话就会一下子连接关闭连接关闭很多次，所以浪费很多性能，所以大佬把这些循环操作的全部改成了一次性操作。</p><p>&nbsp; &nbsp;具体看代码：</p><p>&nbsp; &nbsp;比如我要查询一张表a，有id和parent_id两个字段，parent_id为父id，现在要查出所有数据并把它的父表的数据也查出来</p><p>&nbsp; 实体类A：</p><p>&nbsp; public class A{</p><p>&nbsp; &nbsp; &nbsp;private String id;</p><p>&nbsp; &nbsp; &nbsp;private String parent_id;</p><p>&nbsp; &nbsp; &nbsp;private A parent_a;</p><p>&nbsp; &nbsp; //其他字段以及getset全部省略</p><p>&nbsp; }</p><p>&nbsp; mapper AMapper:</p><p>&nbsp; public&nbsp;<span>interface</span>&nbsp;AMapper{</p><p>&nbsp; &nbsp; &nbsp;//查所有</p><p>&nbsp; &nbsp; List&lt;A&gt; getList();</p><p>&nbsp; &nbsp; //根据id查询单条数据</p><p>&nbsp; &nbsp; A getById(String id);</p><p>&nbsp; }</p><p>&nbsp; //使用循环来实现:</p><p>&nbsp; List&lt;A&gt; list = getList();</p><p>&nbsp; for(A a:list){</p><p>&nbsp; &nbsp; &nbsp;a.setParentA(getById(a.getId()));</p><p>&nbsp; }</p><p>&nbsp;//这样的话就会把父表的数据全部查出来了，但是会循环list.size()次getById()语句，也就是循环list.size()操作数据库</p><p>&nbsp;改良:使用数据库的in语句</p><p>&nbsp;加一条mapper语句:</p><p>&nbsp;方法:</p><p>&nbsp; List&lt;A&gt; getByIds(List&lt;String&gt; ids);</p><p>&nbsp;sql语句:</p><p>&nbsp; select * from a where id in(~);</p><p>&nbsp; 使用mybatis支持的循环，具体怎么使用看百度，一大堆，写在in里面，就循环ids的数据放入in语句里面</p><p>&nbsp; 业务方法:</p><p>&nbsp; List&lt;A&gt; list = getList():</p><p>&nbsp; List&lt;String&gt; ids = new ArrayList&lt;String&gt;();</p><p>&nbsp; for(A a: list){</p><p>&nbsp; &nbsp; ids.add(a.getId());</p><p>&nbsp;}</p><p>&nbsp; List&lt;A&gt; list1 = getByIds(ids);</p><p>&nbsp; for(A a:list){</p><p>&nbsp; &nbsp; for(A a1:list1){</p><p>&nbsp; &nbsp; &nbsp; &nbsp;if(a.getId().equals(a1.getId()){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a.setParentA(a1);</p><p>&nbsp; &nbsp; &nbsp; &nbsp;}</p><p>&nbsp; &nbsp;}</p><p>&nbsp;}</p><p>//这样写的话循环使用mapper语句就变成使用一次了，就执行一次 select * from a where id in(~)就行了</p><p>不过细心的朋友可能会发现使用了两个foreach，就这个：for(A a:list){</p><p>&nbsp; &nbsp; &nbsp; &nbsp;for(A a1:list1){</p><p>&nbsp; &nbsp; &nbsp; &nbsp;}</p><p>&nbsp; &nbsp;}</p><p>这样做的确也会影响性能，因为调用一个方法必须得执行完这个方法才会释放这个方法所占的内存，所以循环一次之后上次循环所占用的内容还在占着，所以这个时候我们要想办法释放这个内存，我当时那个大佬教我的手法就是在外面写一个私有方法，称之为临时内存方法，即把循环里面的循环放到外面去写</p><p>&nbsp; 比如:</p><p>&nbsp; private void buildA(A a,List&lt;A&gt; list){</p><p>&nbsp; &nbsp; &nbsp; for(A a1:list){</p><p>&nbsp; &nbsp; &nbsp; &nbsp;if(a.getId().equals(a1.getId()){</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a.setParentA(a1);</p><p>&nbsp; &nbsp; &nbsp; &nbsp;}</p><p>&nbsp; &nbsp;}</p><p>&nbsp;}</p><p>然后在循环里面调用这个方法:</p><p>&nbsp; for(A a:list){</p><p>&nbsp; &nbsp;buildA(a,list1);</p><p>}</p><p>&nbsp;&nbsp;</p></body>
</html>
