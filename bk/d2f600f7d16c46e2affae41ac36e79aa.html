<!DOCTYPE html>
<html>
<head>
<style>body{padding:1.875rem;}</style><meta charset='UTF-8'>
</head>
<body><p>引用文章：<a target="_blank" href="https://www.jianshu.com/p/59295c91dde7">https://www.jianshu.com/p/59295c91dde7</a></p><h1 class="_1RuRku">Spring Cloud Feign使用详解</h1><div class="rEsl9f"><div class="_2mYfmT"><a class="_1OhGeD" href="https://www.jianshu.com/u/117796446366" target="_blank" rel="noopener noreferrer"><img class="_13D2Eh" src="https://upload.jianshu.io/users/upload_avatars/8796251/43e90e6b-2aa0-470f-a9b7-b3de464633bc.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/96/h/96/format/webp" alt=""></a><div><div class="_3U4Smb"><span class="FxYr8x"><a class="_1OhGeD" href="https://www.jianshu.com/u/117796446366" target="_blank" rel="noopener noreferrer">Chandler_珏瑜</a></span><button data-locale="zh-CN" type="button" class="_3kba3h _1OyPqC _3Mi9q9 _34692-"><span>关注</span></button></div><div class="s-dsoj"><span class="_3tCVn5"><span aria-label="ic-diamond" class="anticon" style="text-align: center;"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#ic-diamond"><svg id="ic-diamond" viewBox="0 0 1026 1024"><path d="M751.144277 307.2l-123.016533-238.933333h159.778133a81.92 81.92 0 0 1 59.1872 25.258666l160.256 167.492267A27.306667 27.306667 0 0 1 987.620011 307.2h-236.475734z m270.506667 111.547733L640.927744 946.039467a27.306667 27.306667 0 0 1-48.128-24.234667L766.504277 375.466667h-56.388266l-170.5984 590.165333a27.306667 27.306667 0 0 1-52.462934 0.034133L315.500544 375.466667H259.112277l174.523734 545.5872a27.306667 27.306667 0 0 1-48.128 24.302933L5.160277 418.747733A27.306667 27.306667 0 0 1 27.346944 375.466667H999.464277a27.306667 27.306667 0 0 1 22.152534 43.281066zM18.301611 261.0176L178.557611 93.525333A81.92 81.92 0 0 1 237.744811 68.266667h159.744L274.506411 307.2H38.030677a27.306667 27.306667 0 0 1-19.729066-46.1824zM453.877077 68.266667h117.896534l122.9824 238.933333H330.894677l122.9824-238.933333z"></path></svg></use></svg></span><span>3</span></span><time datetime="2018-06-28T09:05:56.000Z">2018.06.28 17:05:56</time><span>字数 4,910</span><span>阅读 50,701</span></div></div></div></div><article class="_2rhmJa"><p> 通过前面两章对Spring Cloud Ribbon和Spring Cloud Hystrix的介绍，我们已经掌握了开发微服务应用时，两个重要武器，学会了如何在微服务架构中实现客户端负载均衡的服务调用以及如何通过断路器来保护我们的微服务应用。这两者将被作为基础工具类框架广泛地应用在各个微服务的实现中，不仅包括我们自身的业务类微服务，也包括一些基础设施类微服务（比如网关）。此外，在实践过程中，我们会发现对这两个框架的使用几乎是同时出现的。既然如此，那么是否有更高层次的封装来整合这两个基础工具以简化开发呢？本章我们即将介绍的Spring Cloud Ribbon与Spring Cloud Hystrix，除了提供这两者的强大功能之外，它还提供了一种声明式的Web服务客户端定义方式。</p><p> 我们在使用Spring Cloud Ribbon时，通常都会利用它对RestTemplate的请求拦截来实现对依赖服务的接口调用，而RestTemplate已经实现了对HTTP请求的封装处理，形成了一套模版化的调用方法。在之前的例子中，我们只是简单介绍了RestTemplate调用对实现，但是在实际开发中，由于对服务依赖对调用可能不止于一处，往往一个接口会被多处调用，所以我们通常都会针对各个微服务自行封装一些客户端累来包装这些依赖服务的调用。这个时候我们会发现，由于RestTemplate的封装，几乎每一个调用都是简单的模版化内容。综合上述这些情况，Spring Cloud Fegin在此基础上做了进一步封装，由它来帮助我们定义和实现依赖服务接口的定义。在Spring Cloud Feign的实现下，我们只需创建一个接口并用注解的方式来配置它，即可完成对服务提供方的接口绑定，简化了在使用Spring Cloud Ribbon时自行封装服务调用客户端的开发量。Spring Cloud Feign具备可插拔的注解支持，包括Feign注解和JAX-RS注解。同时，为了适应Spring的广大用户，它在Netflix Feign的基础上扩展了对Spring MVC的注解支持。这对于习惯于Spring MVC的开发者来说，无疑是一个好消息，你我这样可以大大减少学习适应它的成本。另外，对于Feign自身的一些主要组件，比如编码器和解码器等，它也以可插拔的方式提供，在有需求等时候我们以方便扩张和替换它们。</p><h3>快速入门</h3><p> 在本节中，我们将通过一个简单示例来展示Spring Cloud Feign在服务客户端定义所带来的便利。下面等示例将继续使用之前我们实现等hello-service服务，这里我们会通过Spring Cloud Feign提供的声明式服务绑定功能来实现对该服务接口的调用。</p><p>▪️首先，创建一个Spring Boot基础工程，取名为kyle-service-feign，并在pom.xml中引入spring-cloud-starter-eureka和spring-cloud-starter-feign依赖，具体内容如下所示。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-xml"><code class="  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-eureka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-undertow<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Camden.SR7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestones<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestones<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️创建应用主类Application，并通过@EnableFeignClients注解开启Spring Cloud Feign的支持功能。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-java"><code class="  language-java"><span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"com.kyle.client.feign.inter"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️定义HelloServiceFeign，接口@FeignClient注解指定服务名来绑定服务，然后再使用Spring MVC的注解来绑定具体该服务提供的REST接口。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token annotation builtin">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hello-service-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> HelloServiceFeign <span class="token punctuation">{</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><blockquote><p>注意：这里服务名不区分大小写，所以使用hello-service-provider和HELLO-SERVICE-PROVIDER都是可以的。另外，在Brixton.SR5版本中，原有的serviceId属性已经被废弃，若要写属性名，可以使用name或value。</p></blockquote><p>▪️接着，创建一个RestClientController来实现对Feign客户端的调用。使用@Autowired直接注入上面定义的HelloServiceFeign实例，并在postPerson函数中调用这个绑定了hello-service服务接口的客户端来向该服务发起/hello接口的调用。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token annotation builtin">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> RestClientController <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Autowired</span>
    <span class="token keyword">private</span> HelloServiceFeign client<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param name
     * @return Person
     * @Description: 测试服务提供者post接口
     * @create date 2018年5月19日上午9:44:08
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/client/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">postPerson</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param name
     * @return String
     * @Description: 测试服务提供者get接口
     * @create date 2018年5月19日上午9:46:34
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/client/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️最后，同Ribbon实现的服务消费者一样，需要在application.properties中指定服务注册中心，并定义自身的服务名为feign-service-provider，为了方便本地调试与之前的Ribbon消费者区分，端口使用8868。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">#spring.application.name=ribbon-service-provider
eureka.instance.appname=feign-service-provider
eureka.instance.virtualHostName=feign-service-provider
eureka.instance.secureVirtualHostName=feign-service-provider

server.port=8868
eureka.instance.instance-id=${spring.cloud.client.ipAddress}:ribbon-service-provider-peer:${server.port}
#注册到另外两个节点，实现集群
eureka.client.serviceUrl.defaultZone=http://localhost:8887/eureka/,http://localhost:8888/eureka/,http://localhost:8889/eureka/
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h4>测试验证</h4><p></p><p></p> 如之前验证Ribbon客户端负载均衡一样，我们先启动服务注册中心以及两个HELLO-SERVICE-PROVIDER，然后启动FEIGN-SERVICE-PROVIDER，此时我们在Eureka信息面板中可以看到如下内容：<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2822" data-height="1474"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-4f63ab8b265644f8.png" data-original-width="2822" data-original-height="1474" data-original-format="image/png" data-original-filesize="366315" data-image-index="0" class="" src="https://upload-images.jianshu.io/upload_images/8796251-4f63ab8b265644f8.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">注册中心的服务注册</div></div><p> 发送几次GET请求到<span><a href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8868%2Fclient%2FgetHost%3Fname%3Dkyle" target="_blank">http://localhost:8868/client/getHost?name=kyle</a></span>，可以得到如之前Ribbon实现时一样到效果，正确返回<span>hi, kyle! i from 10.166.37.142:8877</span>。依然是利用Ribbon维护了针对HELLO-SERVICE-PROVIDER的服务列表信息，并且通过轮询实现了客户端负载均衡。而与Ribbon不同到是，通过Feign只需定义服务绑定接口，以声明式的方法，优雅而简单地实现了服务调用。</p><h4>测试结果补充<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2546" data-height="1194"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-ff86833b04737882.png" data-original-width="2546" data-original-height="1194" data-original-format="image/png" data-original-filesize="336219" data-image-index="1" class="" src="https://upload-images.jianshu.io/upload_images/8796251-ff86833b04737882.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">8877节点</div></div><div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2560" data-height="1164"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-30fd66b6a56a8393.png" data-original-width="2560" data-original-height="1164" data-original-format="image/png" data-original-filesize="339490" data-image-index="2" class="" src="https://upload-images.jianshu.io/upload_images/8796251-30fd66b6a56a8393.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">8878节点</div></div></h4><h3>参数绑定</h3><p> 现实系统中的各种业务接口要比上一节复杂得多，我们会再HTTP的各个位置传入各种不同类型的参数，并且再返回响应的时候也可能是一个复杂的对象结构。再本节中，我们将详细介绍Feign中的不同形式参数的绑定方法。</p><p> 再开始介绍Spring Cloud Feign的参数绑定之前，我们先扩张以下服务提供者hello-service-provider。增加下面这些接口，其中包含带有Request参数的请求、带有Header信息的请求、带有RequestBody的请求以及请求响应体中是一个对象的请求。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token comment">/**
     * @param name
     * @return Person
     * @Description: post接口
     * @create date 2018年5月19日上午9:44:08
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Person person <span class="token operator">=</span> new <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string">"man"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> person<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param person
     * @return Person
     * @Description: post接口
     * @create date 2018年6月27日下午5:50:56
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestBody</span> Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        person<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setSex</span><span class="token punctuation">(</span><span class="token string">"man"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> person<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param name
     * @return String
     * @Description: get接口
     * @create date 2018年5月19日上午9:46:34
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"hi, "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"! i from "</span> <span class="token operator">+</span> ipAddress <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @param name
     * @param age
     * @return String
     * @Description: get接口,包含header信息
     * @create date 2018年6月27日下午5:43:29
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">,</span> <span class="token annotation builtin">@RequestHeader</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"hi, "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">", your age is "</span> <span class="token operator">+</span> age <span class="token operator">+</span> <span class="token string">"! i from "</span> <span class="token operator">+</span> ipAddress <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 在完成了对hello-service-provider的改造之后，下面我们开始在快速入门示例的kyle-service-feign应用中实现这些新增的绑定。</p><ul><li>首先，在kyle-service-feign中创建Person类。</li><li>然后，在HelloServiceFeign接口中增加对上述三个新增接口的绑定声明，修改后，完成的HelloServiceFeign如下所示：</li></ul><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token annotation builtin">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hello-service-provider"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> HelloServiceFeign <span class="token punctuation">{</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/demo/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/body/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestBody</span> Person person<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/head/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">,</span> <span class="token annotation builtin">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> Integer age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 这里一定要注意，再定义各参数绑定时，@RequestParam、@RequestHeader等可以指定参数名称的主角，它们的value千万不能少。在Spring MVC程序中，这些注解会根据参数名来作为默认值，但是在Feign中绑定参数必须通过value属性来指明具体的参数名，不然会抛出==IllegalStateException==异常，value属性不能为空。</p><ul><li>最后，在RestClientController中新增两个接口，来对本节新增的声明接口调用，修改后的完整代码如下所示：</li></ul><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin">    <span class="token comment">/**
     * @return Person
     * @Description: post接口
     * @create date 2018年6月27日下午5:50:56
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/feign/project/postPerson"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> produces <span class="token operator">=</span> <span class="token string">"application/json; charset=UTF-8"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Person person <span class="token operator">=</span> new <span class="token function">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"kyle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">postPerson</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * @param name
     * @param age
     * @return String
     * @Description: get接口,包含header信息
     * @create date 2018年6月27日下午5:43:29
     */</span>
    <span class="token annotation builtin">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/feign/head/getHost"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">,</span> <span class="token annotation builtin">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h4>测试验证</h4><p> 在完成上述改造之后，启动服务注册中心、两个hello-service-privider服务以及我们改造的kyle-service-feign。通过发送GET请求到==<a href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8868%2Ffeign%2Fhead%2FgetHost%3Fname%3Dkyle%26age%3D18%3D%3D" target="_blank">http://localhost:8868/feign/head/getHost?name=kyle&amp;age=18==</a>，通过发送POST请求到==<a href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8868%2Ffeign%2Fproject%2FpostPerson%3D%3D" target="_blank">http://localhost:8868/feign/project/postPerson==</a>，请求触发HelloServiceFeign对新增接口的调用。最终，我们会获得如下图的结果，代表接口绑定和调试成功。</p><div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="1968" data-height="1090"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-72f3a994acf8d4c2.png" data-original-width="1968" data-original-height="1090" data-original-format="image/png" data-original-filesize="210827" data-image-index="3" class="" src="https://upload-images.jianshu.io/upload_images/8796251-72f3a994acf8d4c2.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">新接口测试</div></div><div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2544" data-height="1202"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-fc1719c064718bc1.png" data-original-width="2544" data-original-height="1202" data-original-format="image/png" data-original-filesize="343716" data-image-index="4" class="" src="https://upload-images.jianshu.io/upload_images/8796251-fc1719c064718bc1.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">新接口测试</div></div><p></p><h3>Ribbon使用</h3><p> 由于Spring Cloud Feign的客户端负载均衡是通过Spring Cloud Ribbon实现的，所以我们可以直接配置Ribbon客户端的方式来自定义各个服务客户端调用参数。那么我们如何使用Spring Cloud Feign的工程中使用Ribbon的配置呢？</p><h4>全局配置</h4><p> 全局配置的方法非常简单，我们可以直接使用ribbon.&lt;key&gt;=&lt;value&gt;的方式来设置ribbon的各项默认参数。如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">#以下配置全局有效
ribbon.eureka.enabled=true
#建立连接超时时间，原1000
ribbon.ConnectTimeout=60000
#请求处理的超时时间，5分钟
ribbon.ReadTimeout=60000
#所有操作都重试
ribbon.OkToRetryOnAllOperations=true
#重试发生，更换节点数最大值
ribbon.MaxAutoRetriesNextServer=10
#单个节点重试最大值
ribbon.MaxAutoRetries=1
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h4>指定服务配置</h4><p> 大多数情况下，我们对于服务调用的超时时间可能会根据实际服务的特性做一些调整，所以仅仅进行个性化配置的方式与使用Spring Cloud Ribbon时的配置方式是意义的，都采用&lt;client&gt;.ribbon.key=value的格式进行设置。但是，这里就有一个疑问了，&lt;cleint&gt;所指代的Ribbon客户端在那里呢？</p><p> 回想一下，在定义Feign客户端的时候，我们使用了@FeignClient注解。在初始化过程中，Spring Cloud Feign会根据该注解的name属性或value属性指定的服务名，自动创建一个同名的Ribbon客户端。如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">#以下配置对服务hello-service-provider有效
hello-service-provider.ribbon.eureka.enabled=true
#建立连接超时时间，原1000
hello-service-provider.ribbon.ConnectTimeout=60000
#请求处理的超时时间，5分钟
hello-service-provider.ribbon.ReadTimeout=60000
#所有操作都重试
hello-service-provider.ribbon.OkToRetryOnAllOperations=true
#重试发生，更换节点数最大值
hello-service-provider.ribbon.MaxAutoRetriesNextServer=10
#单个节点重试最大值
hello-service-provider.ribbon.MaxAutoRetries=1
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h4>负载均衡策略</h4><p> Spring Cloud Ribbon默认负载均衡策略是轮询策略，不过该不一定满足我们的需要。Ribbon一共提供了7种负载均衡策略，如果我们需要ZoneAvoidanceRule，首先要在application.properties文件中添加配置，如下所示：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-undefined"><code class="  language-undefined">ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.ZoneAvoidanceRule
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p> 不过，只是添加了如上配置，还无法实现负载均衡策略的更改。我们还需要实例化该策略，可以在应用主类中直接加入IRule实例的创建，如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-java"><code class="  language-java"><span class="token comment">/**
 * 服务调用者，，eureka客户端 feign调用
 *
 * @version
 * @author kyle 2017年7月9日下午6:39:15
 * @since 1.8
 */</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"com.kyle.client.feign.inter"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">feignRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 想要深入了解Ribbon的原理，或者想详细了解7种负载均衡策略的，可以参考我另一篇博客<a href="https://www.jianshu.com/p/1bd66db5dc46" target="_blank">《Ribbon详解》</a>，我会在博客最下面给出链接。</p><h3>非Spring Boot工程使用Feign</h3><p> 从前两节来看在Spring Boot工程中使用Feign，非常的便利。不过实际生产中，在微服务的初期只能从次要系统开始进行改造，可能很多系统由于历史原因仍然是非Spring Boot的工程，然后这些系统如何使用微服务？如何使用注册中心？如何进行负载均衡呢？</p><p> ▪️首先我们在kyle-service-feign创建调用接口OldSystemPostFeign和OldSystemGetFeign，然后使用feign注解提供的相关注解，包含@RequestLine、@Param、@HeaderParam、@Headers等，主要提供了请求方法、请求参数、头信息参数等操作。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token comment">/**
 * 非Spring Boot工程使用feign组件,post请求
 *
 * @version
 * @author kyle 2018年6月28日下午2:05:39
 * @since 1.8
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> OldSystemPostFeign <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @param person
     * @return Person
     * @Description:
     * @create date 2018年6月28日下午2:08:56
     */</span>
    <span class="token annotation builtin">@RequestLine</span><span class="token punctuation">(</span><span class="token string">"POST /body/postPerson"</span><span class="token punctuation">)</span> <span class="token comment">// post 提交</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"Content-Type: application/json; charset=UTF-8"</span><span class="token punctuation">,</span> <span class="token string">"Accept: application/json; charset=UTF-8"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Person <span class="token function">postPerson</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token comment">/**
 * 非Spring Boot工程使用feign组件,get请求
 *
 * @version
 * @author kyle 2018年6月28日下午3:06:34
 * @since 1.8
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> OldSystemGetFeign <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @param name
     * @return String
     * @Description:
     * @create date 2018年6月28日下午2:08:43
     */</span>
    <span class="token annotation builtin">@RequestLine</span><span class="token punctuation">(</span><span class="token string">"GET /demo/getHost?name={name}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param name
     * @param age
     * @return String
     * @Description:
     * @create date 2018年6月28日下午2:14:38
     */</span>
    <span class="token annotation builtin">@RequestLine</span><span class="token punctuation">(</span><span class="token string">"GET /head/getHost?name={name}"</span><span class="token punctuation">)</span>
    <span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"age: {age}"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">getHost</span><span class="token punctuation">(</span><span class="token annotation builtin">@Param</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">,</span> <span class="token annotation builtin">@Param</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> String age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> ▪️我们需要脱离Spring Boot和Spring Cloud的支持，使用feign原生的一些东西。在进行Feign封装之前我们需要一些额外的组件，比如编码器。新增组件依赖如下所示：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-xml"><code class="  language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.netflix.feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.18.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.netflix.feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.18.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>9.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> ▪️我们需要一个feign-clientproperties文件，来进行ribbon相关的参数配置，配置如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">#对当前实例的重试次数
hello-service-provider.ribbon.MaxAutoRetries=1
#切换实例的重试次数
hello-service-provider.ribbon.MaxAutoRetriesNextServer=2
#对所有操作请求都进行重试
hello-service-provider.ribbon.OkToRetryOnAllOperations=true
#
hello-service-provider.ribbon.ServerListRefreshInterval=2000
#请求连接的超时时间
hello-service-provider.ribbon.ConnectTimeout=3000
#请求处理的超时时间
hello-service-provider.ribbon.ReadTimeout=3000

hello-service-provider.ribbon.listOfServers=localhost:8877,localhost:8878

hello-service-provider.ribbon.EnablePrimeConnections=false
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> ▪️到目前为止，相关要素已经准备好了，接下来需要feign和ribbon的封装了。我们需要创建OldSystemFeignClientConfiguration类，作用是加载feign-client.properties文件，并创建一个附带负载均衡器的RibbonClient，然后封装出一个附带Jackson编解码器的FeignClient，如下所示：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-kotlin"><code class="  language-kotlin"><span class="token comment">/**
 * FeignClient创建类
 *
 * @version
 * @author kyle 2017年8月28日下午2:59:49
 * @since 1.8
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> OldSystemFeignClientConfiguration <span class="token punctuation">{</span>

    <span class="token keyword">private</span> static void <span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 加载配置文件</span>
            ConfigurationManager<span class="token punctuation">.</span><span class="token function">loadPropertiesFromResources</span><span class="token punctuation">(</span><span class="token string">"feign-client.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">final</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

        <span class="token keyword">private</span> static IRule <span class="token function">zoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> new <span class="token function">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> static RibbonClient <span class="token function">getRibbonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建附带负载均衡器的RibbonClient</span>
        <span class="token keyword">final</span> RibbonClient client <span class="token operator">=</span> RibbonClient<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lbClientFactory</span><span class="token punctuation">(</span>new <span class="token function">LBClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation builtin">@Override</span>
            <span class="token keyword">public</span> LBClient <span class="token function">create</span><span class="token punctuation">(</span>String clientName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> IClientConfig config <span class="token operator">=</span> ClientFactory<span class="token punctuation">.</span><span class="token function">getNamedConfig</span><span class="token punctuation">(</span>clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ILoadBalancer lb <span class="token operator">=</span> ClientFactory<span class="token punctuation">.</span><span class="token function">getNamedLoadBalancer</span><span class="token punctuation">(</span>clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> ZoneAwareLoadBalancer zb <span class="token operator">=</span> <span class="token punctuation">(</span>ZoneAwareLoadBalancer<span class="token punctuation">)</span> lb<span class="token punctuation">;</span>
                zb<span class="token punctuation">.</span><span class="token function">setRule</span><span class="token punctuation">(</span><span class="token function">zoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> LBClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>lb<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return OldSystemPostFeign
     * @Description: 实现ribbon负载均衡，使用Jackson进行编解码
     * @create date 2018年6月28日下午2:28:56
     */</span>
    <span class="token keyword">public</span> static OldSystemPostFeign <span class="token function">remotePostService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 封装一个使用Jackson编解码器的FeignClient客户端</span>
        <span class="token keyword">final</span> OldSystemPostFeign computeService <span class="token operator">=</span> Feign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token function">getRibbonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span>new <span class="token function">JacksonEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span>new <span class="token function">JacksonDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>OldSystemPostFeign<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token string">"http://hello-service-provider/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> computeService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return OldSystemGetFeign
     * @Description: 实现ribbon负载均衡，get请求
     * @create date 2018年6月28日下午3:11:55
     */</span>
    <span class="token keyword">public</span> static OldSystemGetFeign <span class="token function">remoteGetService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 封装一个使用Jackson编解码器的FeignClient客户端</span>
        <span class="token keyword">final</span> OldSystemGetFeign computeService <span class="token operator">=</span> Feign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token function">getRibbonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>OldSystemGetFeign<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token string">"http://hello-service-provider/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> computeService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> ▪️然后我需要一个测试类FeignClientTest，测试以上3个接口，然后将结果输出到控台如下所示：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-csharp"><code class="  language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignClientTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OldSystemPostFeign</span> feignPostClient <span class="token operator">=</span> OldSystemFeignClientConfiguration<span class="token punctuation">.</span><span class="token function">remotePostService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        person<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"kyle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>feignPostClient<span class="token punctuation">.</span><span class="token function">postPerson</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OldSystemGetFeign</span> feignGetClient <span class="token operator">=</span> OldSystemFeignClientConfiguration<span class="token punctuation">.</span><span class="token function">remoteGetService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>feignGetClient<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token string">"kyle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>feignGetClient<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token string">"kyle"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> ▪️在完成上述改造之后，启动测试类FeignClientTest，获得如下的结果，说明调用使用了负载均衡。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-swift"><code class="  language-swift"><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.595</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">DynamicServerListLoadBalancer</span> <span class="token operator">-</span> <span class="token builtin">DynamicServerListLoadBalancer</span> <span class="token keyword">for</span> client hello<span class="token operator">-</span>service<span class="token operator">-</span>provider initialized<span class="token punctuation">:</span> <span class="token builtin">DynamicServerListLoadBalancer</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token builtin">NFLoadBalancer</span><span class="token punctuation">:</span>name<span class="token operator">=</span>hello<span class="token operator">-</span>service<span class="token operator">-</span>provider<span class="token punctuation">,</span>current list of <span class="token builtin">Servers</span><span class="token operator">=</span><span class="token punctuation">[</span>localhost<span class="token punctuation">:</span><span class="token number">8877</span><span class="token punctuation">,</span> localhost<span class="token punctuation">:</span><span class="token number">8878</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">Load</span> balancer stats<span class="token operator">=</span><span class="token builtin">Zone</span> stats<span class="token punctuation">:</span> <span class="token punctuation">{</span>unknown<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">Zone</span><span class="token punctuation">:</span>unknown<span class="token punctuation">;</span>   <span class="token builtin">Instance</span> <span class="token builtin">count</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">;</span>   <span class="token builtin">Active</span> connections <span class="token builtin">count</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Circuit</span> breaker tripped <span class="token builtin">count</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Active</span> connections per server<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token builtin">Server</span> stats<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">Server</span><span class="token punctuation">:</span>localhost<span class="token punctuation">:</span><span class="token number">8878</span><span class="token punctuation">;</span>    <span class="token builtin">Zone</span><span class="token punctuation">:</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>   <span class="token builtin">Total</span> <span class="token builtin">Requests</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Successive</span> connection failure<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Total</span> blackout seconds<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Last</span> connection made<span class="token punctuation">:</span><span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>  <span class="token builtin">First</span> connection made<span class="token punctuation">:</span> <span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>    <span class="token builtin">Active</span> <span class="token builtin">Connections</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   total failure <span class="token builtin">count</span> <span class="token keyword">in</span> <span class="token builtin">last</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> msecs<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span> average resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token number">90</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token number">95</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token builtin">min</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token builtin">max</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  stddev resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">]</span>
<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token builtin">Server</span><span class="token punctuation">:</span>localhost<span class="token punctuation">:</span><span class="token number">8877</span><span class="token punctuation">;</span>   <span class="token builtin">Zone</span><span class="token punctuation">:</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>   <span class="token builtin">Total</span> <span class="token builtin">Requests</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Successive</span> connection failure<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Total</span> blackout seconds<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Last</span> connection made<span class="token punctuation">:</span><span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>  <span class="token builtin">First</span> connection made<span class="token punctuation">:</span> <span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>    <span class="token builtin">Active</span> <span class="token builtin">Connections</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   total failure <span class="token builtin">count</span> <span class="token keyword">in</span> <span class="token builtin">last</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> msecs<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span> average resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token number">90</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token number">95</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token builtin">min</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token builtin">max</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  stddev resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token builtin">ServerList</span><span class="token punctuation">:</span>com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">ConfigurationBasedServerList@489115ef</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.595</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token builtin">ClientFactory</span> <span class="token operator">-</span> <span class="token builtin">Client</span><span class="token punctuation">:</span>hello<span class="token operator">-</span>service<span class="token operator">-</span>provider instantiated a <span class="token builtin">LoadBalancer</span><span class="token punctuation">:</span><span class="token builtin">DynamicServerListLoadBalancer</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token builtin">NFLoadBalancer</span><span class="token punctuation">:</span>name<span class="token operator">=</span>hello<span class="token operator">-</span>service<span class="token operator">-</span>provider<span class="token punctuation">,</span>current list of <span class="token builtin">Servers</span><span class="token operator">=</span><span class="token punctuation">[</span>localhost<span class="token punctuation">:</span><span class="token number">8877</span><span class="token punctuation">,</span> localhost<span class="token punctuation">:</span><span class="token number">8878</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token builtin">Load</span> balancer stats<span class="token operator">=</span><span class="token builtin">Zone</span> stats<span class="token punctuation">:</span> <span class="token punctuation">{</span>unknown<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">Zone</span><span class="token punctuation">:</span>unknown<span class="token punctuation">;</span>    <span class="token builtin">Instance</span> <span class="token builtin">count</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">;</span>   <span class="token builtin">Active</span> connections <span class="token builtin">count</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Circuit</span> breaker tripped <span class="token builtin">count</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Active</span> connections per server<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token builtin">Server</span> stats<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">Server</span><span class="token punctuation">:</span>localhost<span class="token punctuation">:</span><span class="token number">8878</span><span class="token punctuation">;</span>    <span class="token builtin">Zone</span><span class="token punctuation">:</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>   <span class="token builtin">Total</span> <span class="token builtin">Requests</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Successive</span> connection failure<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Total</span> blackout seconds<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Last</span> connection made<span class="token punctuation">:</span><span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>  <span class="token builtin">First</span> connection made<span class="token punctuation">:</span> <span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>    <span class="token builtin">Active</span> <span class="token builtin">Connections</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   total failure <span class="token builtin">count</span> <span class="token keyword">in</span> <span class="token builtin">last</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> msecs<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span> average resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token number">90</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token number">95</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token builtin">min</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token builtin">max</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  stddev resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">]</span>
<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token builtin">Server</span><span class="token punctuation">:</span>localhost<span class="token punctuation">:</span><span class="token number">8877</span><span class="token punctuation">;</span>   <span class="token builtin">Zone</span><span class="token punctuation">:</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span>   <span class="token builtin">Total</span> <span class="token builtin">Requests</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Successive</span> connection failure<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token builtin">Total</span> blackout seconds<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   <span class="token builtin">Last</span> connection made<span class="token punctuation">:</span><span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>  <span class="token builtin">First</span> connection made<span class="token punctuation">:</span> <span class="token builtin">Thu</span> <span class="token builtin">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span><span class="token punctuation">;</span>    <span class="token builtin">Active</span> <span class="token builtin">Connections</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span>   total failure <span class="token builtin">count</span> <span class="token keyword">in</span> <span class="token builtin">last</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> msecs<span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">;</span> average resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token number">90</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token number">95</span> percentile resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>    <span class="token builtin">min</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  <span class="token builtin">max</span> resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">;</span>  stddev resp time<span class="token punctuation">:</span><span class="token number">0.0</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token builtin">ServerList</span><span class="token punctuation">:</span>com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">ConfigurationBasedServerList@489115ef</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.598</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token builtin">ChainedDynamicProperty</span> <span class="token operator">-</span> <span class="token builtin">Flipping</span> property<span class="token punctuation">:</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span><span class="token builtin">ActiveConnectionsLimit</span> to use <span class="token constant">NEXT</span> property<span class="token punctuation">:</span> niws<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>availabilityFilteringRule<span class="token punctuation">.</span>activeConnectionsLimit <span class="token operator">=</span> <span class="token number">2147483647</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.639</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">ZoneAwareLoadBalancer</span> <span class="token operator">-</span> <span class="token builtin">Zone</span> aware logic disabled or there <span class="token keyword">is</span> only one zone
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.647</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">LoadBalancerContext</span> <span class="token operator">-</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider using <span class="token constant">LB</span> returned <span class="token builtin">Server</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8877</span> <span class="token keyword">for</span> request http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//body/postPerson</span>
<span class="token builtin">Person</span> <span class="token punctuation">[</span>name<span class="token operator">=</span>kyle<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> sex<span class="token operator">=</span>man<span class="token punctuation">]</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.756</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token builtin">ChainedDynamicProperty</span> <span class="token operator">-</span> <span class="token builtin">Flipping</span> property<span class="token punctuation">:</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span><span class="token builtin">ActiveConnectionsLimit</span> to use <span class="token constant">NEXT</span> property<span class="token punctuation">:</span> niws<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>availabilityFilteringRule<span class="token punctuation">.</span>activeConnectionsLimit <span class="token operator">=</span> <span class="token number">2147483647</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.757</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">ZoneAwareLoadBalancer</span> <span class="token operator">-</span> <span class="token builtin">Zone</span> aware logic disabled or there <span class="token keyword">is</span> only one zone
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.757</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">LoadBalancerContext</span> <span class="token operator">-</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider using <span class="token constant">LB</span> returned <span class="token builtin">Server</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8877</span> <span class="token keyword">for</span> request http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//demo/getHost?name=kyle</span>
hi<span class="token punctuation">,</span> kyle<span class="token operator">!</span> i from <span class="token number">10.166</span><span class="token punctuation">.</span><span class="token number">37.142</span><span class="token punctuation">:</span><span class="token number">8877</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.762</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token builtin">ChainedDynamicProperty</span> <span class="token operator">-</span> <span class="token builtin">Flipping</span> property<span class="token punctuation">:</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span><span class="token builtin">ActiveConnectionsLimit</span> to use <span class="token constant">NEXT</span> property<span class="token punctuation">:</span> niws<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span>availabilityFilteringRule<span class="token punctuation">.</span>activeConnectionsLimit <span class="token operator">=</span> <span class="token number">2147483647</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.763</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">ZoneAwareLoadBalancer</span> <span class="token operator">-</span> <span class="token builtin">Zone</span> aware logic disabled or there <span class="token keyword">is</span> only one zone
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.763</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">DEBUG</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">LoadBalancerContext</span> <span class="token operator">-</span> hello<span class="token operator">-</span>service<span class="token operator">-</span>provider using <span class="token constant">LB</span> returned <span class="token builtin">Server</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8877</span> <span class="token keyword">for</span> request http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//head/getHost?name=kyle</span>
hi<span class="token punctuation">,</span> kyle<span class="token punctuation">,</span> your age <span class="token keyword">is</span> <span class="token number">18</span><span class="token operator">!</span> i from <span class="token number">10.166</span><span class="token punctuation">.</span><span class="token number">37.142</span><span class="token punctuation">:</span><span class="token number">8877</span>
<span class="token number">15</span><span class="token punctuation">:</span><span class="token number">21</span><span class="token punctuation">:</span><span class="token number">45.770</span> <span class="token punctuation">[</span><span class="token builtin">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span> com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span><span class="token builtin">PollingServerListUpdater</span> <span class="token operator">-</span> <span class="token builtin">Shutting</span> down the <span class="token builtin">Executor</span> <span class="token builtin">Pool</span> <span class="token keyword">for</span> <span class="token builtin">PollingServerListUpdater</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 细心的同学会发现，非Spring Boot使用feign调用根本没有使用到注册中心的服务发现。在此我提供一个思路，我们可以调用代理微服务，再由代理进行服务发现。那么这个代理服务应该具备哪些功能和作用呢？我将会在下一篇博客详细讲述Netflix公司的API网关组件zuul，它承担路由转发，拦截过滤，流量控制等功能。</p><h3>feign使用遇到的一些重要point</h3><p>▪️<span>第一次请求失败</span></p><p> 原因：由于spring的懒加载机制导致大量的类只有在真正使用的才会真正创建，由于默认的熔断超时时间（1秒）过短，导致第一次请求很容易失败，特别互相依赖复杂的时候。</p><p> 解决方法：提升熔断超时时间和ribbon超时时间，配置如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-csharp"><code class="  language-csharp"><span class="token preprocessor property">#设置hystrix超时时间</span>
hystrix<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>execution<span class="token punctuation">.</span>isolation<span class="token punctuation">.</span>thread<span class="token punctuation">.</span>timeoutInMilliseconds<span class="token operator">=</span><span class="token number">60000</span>
<span class="token preprocessor property">#请求处理的超时时间</span>
ribbon<span class="token punctuation">.</span>ReadTimeout<span class="token operator">=</span><span class="token number">10000</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️<span>Feign的Http Client</span></p><p> Feign在默认情况下使用的是JDK原生URLConnection发送HTTP请求，没有连接池，但是对每个地址会保持一个长连接，即利用HTTP的persistence connection。我们可以用Apache的HTTP Client替换Feign原始的http client，从而获取连接池、超时时间等与性能息息相关的控制能力。Spring Cloud从Brixtion.SR5版本开始支持这种替换，首先在项目中声明Apcahe HTTP Client和feign-httpclient依赖,然后在application.properties中添加：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">feign.httpclient.enabled=true
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>▪️<span>如何实现在feign请求之前进行操作</span></p><p> feign组件提供了请求操作接口RequestInterceptor，实现之后对apply函数进行重写就能对request进行修改，包括header和body操作。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart"><span class="token comment">/**
 * 使用自定义的RequestInterceptor，在request发送之前，将信息放入请求
 *
 * @version
 * @author kyle 2017年8月31日上午10:23:01
 * @since 1.8
 */</span>
<span class="token metadata symbol">@Component</span>
public <span class="token keyword">class</span> <span class="token class-name">TokenRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>
    <span class="token metadata symbol">@Override</span>
    public <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>RequestTemplate template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String method <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String url <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️<span>请求压缩</span><br> Spring Cloud Feign支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。我们只需通过下面两个参数设置，就能开启请求与响应的压缩功能：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">feign.compression.request.enabled=true
feign.compression.response.enabled=true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div><p> 同时，我们还能对请求压缩做一些更细致的设置，比如下面的配置内容指定了压缩的请求数据类型，并设置了压缩的大小下限，只有超过这个大小的请求才会对其进行压缩。</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-bash"><code class="  language-bash">feign.compression.request.enabled=true
feign.compression.request.nime-types=text/xml,application/xml,application/json
feign.compression.requestmin-request-size=2048
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><p> 上述配置的feign.compression.request.nime-types和feign.compression.requestmin-request-size均为默认值。</p><p>▪️<span>日志配置</span></p><p> Spring Cloud Feign在构建被@FeignClient注解修饰的服务客户端时，会为每一个客户端都创建一个feign的请求细节。可以在<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fapplication.properties" target="_blank">application.properties</a>文件中使用logging.level.&lt;FeignClient&gt;的参数配置格式来开启指定Feign客户端的DEBUG日志，其中&lt;FeignClient&gt;为Feign客户端定义捷克队完整路径，比如针对本博文中我们实现的HelloServiceFeign可以如下配置开启：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-undefined"><code class="  language-undefined">logging.level.com.kyle.client.feign.inter.HelloServiceFeign=DEBUG
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p> 但是，只是添加了如上配置，还无法实现对DEBUG日志的输出。这时由于Feign客户端默认对Logger.Level对象定义为NONE级别，该界别不会记录任何Feign调用过程中对信息，所以我们需要调整它对级别，针对全局对日志级别，可以在应用主类中直接假如Logger.Level的Bean创建，具体如下：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-java"><code class="  language-java"><span class="token comment">/**
 * 服务调用者，，eureka客户端 feign调用
 *
 * @version
 * @author kyle 2017年7月9日下午6:39:15
 * @since 1.8
 */</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"com.kyle.client.feign.inter"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 在调整日志级别为FULL之后，我们可以再访问第一节的<a href="https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A8868%2Ffeign%2FpostPerson%3Fname%3Dkyle" target="_blank">http://localhost:8868/feign/postPerson?name=kyle</a>接口，这是我们在kyle-service-feign的控制台中可以看到类似下面的请求详细的日志：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-swift"><code class="  language-swift"><span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.393</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span> <span class="token punctuation">(</span>302ms<span class="token punctuation">)</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.393</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> connection<span class="token punctuation">:</span> keep<span class="token operator">-</span>alive
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.394</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> content<span class="token operator">-</span>type<span class="token punctuation">:</span> application<span class="token operator">/</span>json<span class="token punctuation">;</span>charset<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.394</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> date<span class="token punctuation">:</span> <span class="token builtin">Thu</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token builtin">Jun</span> <span class="token number">2018</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58</span> <span class="token constant">GMT</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.394</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> transfer<span class="token operator">-</span>encoding<span class="token punctuation">:</span> chunked
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.394</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> 
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.396</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span><span class="token string">"kyle"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">:</span><span class="token string">"10"</span><span class="token punctuation">,</span><span class="token string">"sex"</span><span class="token punctuation">:</span><span class="token string">"man"</span><span class="token punctuation">}</span>
<span class="token number">2018</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">28</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">58.396</span> <span class="token constant">DEBUG</span> <span class="token number">4140</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>vice<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> c<span class="token punctuation">.</span>k<span class="token punctuation">.</span>c<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>inter<span class="token punctuation">.</span><span class="token builtin">HelloServiceFeign</span>      <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">HelloServiceFeign#postPerson</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token constant">END</span> <span class="token constant">HTTP</span> <span class="token punctuation">(</span><span class="token number">38</span><span class="token operator">-</span>byte body<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 对于Feign的Logger级别主要有下面4类，可根据实际需要进行调整使用。</p><ul><li><span>NONE</span>：不记录任何信息。</li><li><span>BASIC</span>：仅记录请求方法、URL以及响应状态码和执行时间。</li><li><span>HEADERS</span>：出了记录BASIC级别的信息之外，还会记录请求和响应的头信息。</li><li><span>FULL</span>：记录所有请求与响应的细节，包括头信息、请求体、元数据等。</li></ul><p>▪️<span>负载均衡异常</span></p><p> 当我们只是对一个微服务进行调用的时候，Ribbon提供的支持好像没什么问题。不过在我们进行多个微服务调用时会产生异常，这也是大多数人忽略的。</p><p> <span>情景描述</span>：2个应用B和C,在A中使用feign client调用B和C；测试结果，假如先调用B，再调用C都是有效的，但是再调用B就是无效的；（B,C先后顺序改变，都会产生这个bug）<br> <span>解决方法</span>：在主启动类使用注解@RibbonClient，进行RibbonClient配置，如下所示：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-java"><code class="  language-java"><span class="token comment">/**
 * 服务调用者，，eureka客户端 feign调用
 *
 * @version
 * @author kyle 2017年7月9日下午6:39:15
 * @since 1.8
 */</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@RibbonClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hello-service-provider"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"com.kyle.client.feign.inter"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">feignRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3>RSA加解签</h3><p></p><p></p> 一位博友提醒我应该补充一下encoder和decoder，让我想到了我公司之前一个需求，保证请求响应过程时body中的数据处于加密状态（互联网金融安全性要求）？我当初是自己下载源码，然后对内部代码进行梳理，最后找到介入点，改造成功。现在我带大家认识一下我是如何接入的，如下是我是梳理的时序图：<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="1810" data-height="1184"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-8613a9ba8def5f07.png" data-original-width="1810" data-original-height="1184" data-original-format="image/png" data-original-filesize="91409" data-image-index="5" class="" src="https://upload-images.jianshu.io/upload_images/8796251-8613a9ba8def5f07.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">feign组件.png</div></div><h4>内部类Builder</h4><p> 看不懂是吗？不要紧，我下面详细讲解一下，先看一下我们之前的非Spring Boot工程中封装FeignClient：</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart"><span class="token comment">// 封装一个使用Jackson编解码器的FeignClient客户端</span>
<span class="token keyword">final</span> OldSystemPostFeign computeService <span class="token operator">=</span> Feign<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token function">getRibbonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">encoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JacksonEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JacksonDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>OldSystemPostFeign<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"http://hello-service-provider/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div><p></p><p></p> 我们先来看一下Feign内部类Builder，我们所有可以进行配置的要素都在下图中:<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2370" data-height="758"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-8469e525f6c028df.png" data-original-width="2370" data-original-height="758" data-original-format="image/png" data-original-filesize="499436" data-image-index="6" class="" src="https://upload-images.jianshu.io/upload_images/8796251-8469e525f6c028df.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">Feign内部类Builder</div></div><h4>JDK动态代理</h4><p> OldSystemPostFeign只是一个接口，Feign为什么需要使用接口来调用远程接口？原因就是使用JDK动态代理，我们可以去看Feign是如何进行处理。</p><ul><li><p></p><p></p>首先，我们看一下内部类Builder的builder函数：<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2640" data-height="1286"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-f997b4943edc7236.png" data-original-width="2640" data-original-height="1286" data-original-format="image/png" data-original-filesize="703242" data-image-index="7" class="" src="https://upload-images.jianshu.io/upload_images/8796251-f997b4943edc7236.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">builder函数</div></div></li><li><p></p><p></p>如上图所示，返回都是Feign的子类ReflectiveFeign，我们去看看ReflectiveFeign里面做了什么，很明显使用了JDK动态代理：<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="2568" data-height="1302"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-9b2c4d1558bc82fc.png" data-original-width="2568" data-original-height="1302" data-original-format="image/png" data-original-filesize="745822" data-image-index="8" class="" src="https://upload-images.jianshu.io/upload_images/8796251-9b2c4d1558bc82fc.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">eflectiveFeign的newInstance函数</div></div></li></ul><ol><li>遍历目标接口的所有方法</li><li>添加默认实现</li><li>创建动态代理处理器</li><li>进行代理</li></ol><ul><li>如上图所示，我们已经知道Feign使用动态代理，这就是为什么我们只要接口封装远程接口就可以实现调用了，因为Feign给我们都每个调用接口创建了对应的代理类进行请求处理和响应处理。注意上图的第三步，以下是我顺便贴出代码实现逻辑，找出代理类：</li><li></li></ul><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart"><span class="token comment">//接口InvocationHandlerFactory的create的函数</span>
<span class="token comment">/**
 * Controls reflective method dispatch.
 */</span>
public interface <span class="token class-name">InvocationHandlerFactory</span> <span class="token punctuation">{</span>

  InvocationHandler <span class="token function">create</span><span class="token punctuation">(</span>Target target<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>Method<span class="token punctuation">,</span> MethodHandler<span class="token operator">&gt;</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Like {@link InvocationHandler#invoke(Object, java.lang.reflect.Method, Object[])}, except for a
   * single method.
   */</span>
  interface <span class="token class-name">MethodHandler</span> <span class="token punctuation">{</span>

    Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> throws Throwable<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Default</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandlerFactory</span> <span class="token punctuation">{</span>

    <span class="token metadata symbol">@Override</span>
    public InvocationHandler <span class="token function">create</span><span class="token punctuation">(</span>Target target<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>Method<span class="token punctuation">,</span> MethodHandler<span class="token operator">&gt;</span> dispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveFeign<span class="token punctuation">.</span>FeignInvocationHandler</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//其实create函数返回是FeignInvocationHandler，它就是动态代理处理器</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FeignInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>

    private <span class="token keyword">final</span> Target target<span class="token punctuation">;</span>
    private <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Method<span class="token punctuation">,</span> MethodHandler<span class="token operator">&gt;</span> dispatch<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token metadata symbol">@Override</span>
    public Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Throwable <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> dispatch<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li><p></p><p></p>接下来，我们开始去找寻目标接口的每个方法的执行者，我们先要看接口的MethodHandler实现类：<div class="image-package" style="text-align: center;"><div class="image-container"><div class="image-container-fill"></div><div class="image-view" data-width="1838" data-height="210"><img data-original-src="//upload-images.jianshu.io/upload_images/8796251-800b059ac6ac83e8.png" data-original-width="1838" data-original-height="210" data-original-format="image/png" data-original-filesize="55830" data-image-index="9" class="" src="https://upload-images.jianshu.io/upload_images/8796251-800b059ac6ac83e8.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp"></div></div><div class="image-caption">MethodHandler实现类</div></div></li><li>如上图所示，默认实现类是SynchronousMethodHandler，当你看它的时候你就知道你找对了。</li></ul><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-java"><code class="  language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousMethodHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MethodHandler</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> MAX_RESPONSE_BUFFER_SIZE <span class="token operator">=</span> <span class="token number">8192L</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MethodMetadata</span> metadata<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Target</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> target<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Client</span> client<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Retryer</span> retryer<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">&gt;</span></span> requestInterceptors<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span> logLevel<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestTemplate</span><span class="token punctuation">.</span><span class="token class-name">Factory</span> buildTemplateFromArgs<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Options</span> options<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Decoder</span> decoder<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ErrorDecoder</span> errorDecoder<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> decode404<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">RequestTemplate</span> template <span class="token operator">=</span> buildTemplateFromArgs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//feign的重试机制</span>
    <span class="token class-name">Retryer</span> retryer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retryer<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RetryableException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retryer<span class="token punctuation">.</span><span class="token function">continueOrPropagate</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">logRetry</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Object</span> <span class="token function">executeAndDecode</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token function">targetRequest</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">logRequest</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Response</span> response<span class="token punctuation">;</span>
    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//HttpClient调用，返回response</span>
      response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logLevel <span class="token operator">!=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token class-name">Level</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">logIOException</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token function">elapsedTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">throw</span> <span class="token function">errorExecuting</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//连接超时时间处理</span>
    <span class="token keyword">long</span> elapsedTime <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> shouldClose <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//响应成功，进行解码</span>
          <span class="token keyword">return</span> <span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>decode404 <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//响应失败，进行解码</span>
        <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//响应失败，使用异常解码器解码</span>
        <span class="token keyword">throw</span> errorDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">configKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token class-name">Object</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//使用默认解码器解码，如果你设置了解码器，使用设置的进行解码</span>
      <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FeignException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DecodeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul><li>如上源码所示，我们可以清晰的看待Feign调用响应之后对Response进行解码的过程，不过怎么没有看到Request进行编码呢，其实在创建RestTemplate的时候就已经进行编码了，我们来看看ReflectiveFeign的内部类BuildEncodedTemplateFromArgs和BuildFormEncodedTemplateFromArgs：</li></ul><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart">    private <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BuildFormEncodedTemplateFromArgs</span> <span class="token keyword">extends</span> <span class="token class-name">BuildTemplateByResolvingArgs</span> <span class="token punctuation">{</span>

    private <span class="token keyword">final</span> Encoder encoder<span class="token punctuation">;</span>

    private <span class="token function">BuildFormEncodedTemplateFromArgs</span><span class="token punctuation">(</span>MethodMetadata metadata<span class="token punctuation">,</span> Encoder encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>encoder <span class="token operator">=</span> encoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token metadata symbol">@Override</span>
    protected RequestTemplate <span class="token function">resolve</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> RequestTemplate mutable<span class="token punctuation">,</span>
                                      Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> formVariables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> entry <span class="token punctuation">:</span> variables<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">formParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          formVariables<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>formVariables<span class="token punctuation">,</span> Encoder<span class="token punctuation">.</span>MAP_STRING_WILDCARD<span class="token punctuation">,</span> mutable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EncodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EncodeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> mutable<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 private <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BuildEncodedTemplateFromArgs</span> <span class="token keyword">extends</span> <span class="token class-name">BuildTemplateByResolvingArgs</span> <span class="token punctuation">{</span>

    private <span class="token keyword">final</span> Encoder encoder<span class="token punctuation">;</span>

    private <span class="token function">BuildEncodedTemplateFromArgs</span><span class="token punctuation">(</span>MethodMetadata metadata<span class="token punctuation">,</span> Encoder encoder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>encoder <span class="token operator">=</span> encoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token metadata symbol">@Override</span>
    protected RequestTemplate <span class="token function">resolve</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> RequestTemplate mutable<span class="token punctuation">,</span>
                                      Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object body <span class="token operator">=</span> argv<span class="token punctuation">[</span>metadata<span class="token punctuation">.</span><span class="token function">bodyIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">checkArgument</span><span class="token punctuation">(</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Body parameter %s was null"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">bodyIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">bodyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mutable<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EncodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EncodeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> mutable<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h4>源码改造</h4><p> 至此我们已经熟悉了，Feign整个调用过程以及编码器和解码器的使用，接下来看看我是如何进行RSA加解签。</p><p>▪️<span>改造方法</span></p><ul><li>request之前：使用RequestIntercept拦截请求，将body数据进行解密，然后再放入body。</li><li>reponse之前：SynchronousMethodHandler的invoke函数执行具体的调用，在响应body进行json转换之前，将body数据进行解密，然后转换成对象返回。</li></ul><p>▪️<span>加签</span></p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart"><span class="token comment">/**
 * Feign请求之前，进行RSA加密
 * 
 * @version
 * @author kyle 2018年5月23日下午1:59:40
 * @since 1.8
 */</span>
public <span class="token keyword">class</span> <span class="token class-name">RSAEncryptRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>

    <span class="token metadata symbol">@Override</span>
    public <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>RequestTemplate template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// RSA加密</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getPrivateKeyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String key <span class="token operator">=</span> <span class="token function">getPrivateKeyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> key <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"POST"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                byte<span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    String bodyContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    String encryptData <span class="token operator">=</span> RSAUtil<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bodyContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    template<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>encryptData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> unsupportedE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    unsupportedE<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>▪️<span>解签</span></p><p> 由于Feign并没有提供对Response操作对接口，所以我只能改动源码，切入点是SynchronousMethodHandler的decode函数</p><div class="_2Uzcx_"><button class="VJbwyy" type="button" aria-label="复制代码"><span aria-label="icon: copy" class="anticon anticon-copy"><svg viewBox="64 64 896 896" focusable="false" class="" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></span></button><pre class="line-numbers  language-dart"><code class="  language-dart">Object <span class="token function">decode</span><span class="token punctuation">(</span>Response response<span class="token punctuation">)</span> throws Throwable <span class="token punctuation">{</span>
        Request request <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String serviceId <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String publicKey <span class="token operator">=</span> <span class="token function">getPublicKeyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// RSA解密</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> publicKey <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                byte<span class="token punctuation">[</span><span class="token punctuation">]</span> bodyData <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String bodyContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bodyData<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String decryptData <span class="token operator">=</span> RSAUtil<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bodyContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>decryptData<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FeignException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DecodeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">ensureClosed</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p> 至此一个通用的基于Feign加解签的组件就开发完成了，不需要业务开发者再去考虑加解签的事情，让他们可以专注于业务。</p></article></body>
</html>
